<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√≥c Ti√™n Tri - Mystic Corner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #fce4ec;
            --card-bg: #fffbf0;
            --accent-gold: #d4af37;
            --text-color: #5d4037;
            --highlight: #ff80ab;
            --shadow: 0 10px 30px rgba(93, 64, 55, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: #fdfbf7;
            /* Clean warm base */
            /* Removed old linear gradient in favor of mesh blobs */

            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            text-align: center;
            text-align: center;
            padding: 20px;
        }

        html,
        body {
            overflow-x: hidden;
            width: 100%;
        }


        .bg-shape {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            /* Massive blur for smooth gradient */
            z-index: -1;
            opacity: 0.8;
            animation: moveShape 20s infinite alternate;
        }

        .shape-1 {
            width: 500px;
            height: 500px;
            background: #ff9a9e;
            top: -10%;
            left: -10%;
            animation-delay: 0s;
        }

        .shape-2 {
            width: 400px;
            height: 400px;
            background: #a18cd1;
            bottom: 10%;
            right: -5%;
            animation-duration: 25s;
        }

        .shape-3 {
            width: 300px;
            height: 300px;
            background: #fad0c4;
            top: 40%;
            left: 40%;
            animation-duration: 18s;
            animation-delay: -5s;
        }

        @keyframes moveShape {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            100% {
                transform: translate(50px, 50px) rotate(20deg);
            }
        }


        header {
            margin-bottom: 2rem;
            z-index: 10;
            position: relative;
        }

        h1 {
            font-family: 'Pacifico', cursive;
            font-size: 3.5rem;
            color: #fff;
            text-shadow: 3px 3px 0px var(--highlight), 6px 6px 0px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
            animation: float 6s ease-in-out infinite;
        }

        p.subtitle {
            font-size: 1.2rem;
            color: #fff;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .stage {
            perspective: 1000px;
            width: 100%;
            max-width: 1200px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Card Container Styles */
        .card-container {
            width: 180px;
            height: 280px;
            position: absolute;
            cursor: pointer;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.5s ease;
            transform-style: preserve-3d;
            transform: translateX(0) scale(1);
        }

        .card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
            box-shadow: var(--shadow);
            border-radius: 15px;
        }

        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            backface-visibility: hidden;
            overflow: hidden;
            border: 4px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--card-bg);
        }

        .card-back {
            background-image: url('assets/card-back.png');
            background-size: cover;
            background-position: center;
        }

        /* Holographic sheen attempt */
        .card-back::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(115deg, transparent 40%, rgba(255, 255, 255, 0.4) 50%, transparent 60%);
            background-size: 200% 100%;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .card-container:hover .card-inner {
            transform: translateY(-20px);
            box-shadow: 0 25px 50px rgba(93, 64, 55, 0.3);
        }

        .card-container:hover .card-back::before {
            opacity: 1;
            animation: holoShift 1s infinite linear;
        }

        @keyframes holoShift {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .card-front {
            transform: rotateY(180deg);
            background-size: cover;
            background-position: center;
        }

        /* Holo Sheen for Revealed Card (Front) */
        .card-front::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(125deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0) 35%,
                    rgba(255, 255, 255, 0.4) 45%,
                    rgba(255, 255, 255, 0.8) 50%,
                    rgba(255, 255, 255, 0.4) 55%,
                    rgba(255, 255, 255, 0) 65%,
                    rgba(255, 255, 255, 0) 100%);
            z-index: 2;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            mix-blend-mode: screen;
        }

        .card-container.selected .card-front::after {
            opacity: 1;
            animation: holoSweep 2.5s infinite ease-in-out;
        }

        @keyframes holoSweep {
            0% {
                background-position: -250% 0;
            }

            100% {
                background-position: 250% 0;
            }
        }

        /* Selected State */
        .stage.has-selection .card-container {
            pointer-events: none;
        }

        .show-result .stage {
            position: relative;
            z-index: 160;
            /* Above backdrop (150) */
            pointer-events: none;
            /* Let clicks pass to backdrop */
        }

        .show-result .card-container.selected {
            pointer-events: auto;
            /* Allow card interaction if any */
        }

        .stage.has-selection .card-container.selected {
            z-index: 100;
            transform: translate(0, 0) scale(1.5) rotate(0deg) !important;
            /* Zoom to center on desktop */
        }

        /* Mobile Specifics - Deck View */

        /* Controls */
        .controls {
            margin-top: 2rem;
            z-index: 20;
            display: flex;
            gap: 1rem;
        }

        .btn-main {
            background: linear-gradient(135deg, #ff80ab, #ff4081);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-family: 'Quicksand', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 64, 129, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-main:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-main:active {
            transform: translateY(1px) scale(0.98);
        }

        .btn-main.hide {
            display: none;
        }

        /* Result Panel */
        /* Result Panel */
        .result-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -40%) scale(0.9);
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: rgba(255, 255, 255, 0.7);
            /* Glass Desktop */
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            padding: 2rem;
            border-radius: 30px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.6);
            width: 90%;
            max-width: 400px;
            z-index: 200;
            transition-delay: 0s;
            /* Reset delay on close */
        }

        .show-result .result-panel {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
            transition-delay: 0.6s;
            /* Wait for card flip */
        }

        .show-result .controls {
            display: none !important;
        }

        .result-title {
            font-family: 'Pacifico', cursive;
            font-size: 2.5rem;
            color: var(--highlight);
            margin-bottom: 0.5rem;
        }

        .result-desc {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            line-height: 1.6;
            color: #555;
        }

        /* Sparkles */
        .sparkle {
            position: absolute;
            background: white;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            animation: twinkle 1.5s infinite ease-in-out;
            box-shadow: 0 0 10px white;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes twinkle {

            0%,
            100% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Mobile Responsive Polishing */
        @media (max-width: 768px) {
            header {
                margin-bottom: 0.5rem;
                transition: opacity 0.5s;
            }

            .show-result header {
                opacity: 0;
                pointer-events: none;
            }

            h1 {
                font-size: 2rem;
            }

            p.subtitle {
                font-size: 0.9rem;
            }

            .result-title {
                font-size: 1.8rem;
            }

            .result-desc {
                font-size: 1rem;
            }

            .name-input {
                font-size: 0.9rem;
            }

            .btn-main {
                font-size: 1rem;
                padding: 0.8rem 2rem;
            }

            .stage {
                height: 45vh;
                min-height: 400px;
                width: 100%;
                overflow: visible;
                /* Let cards fly but body hides them */
            }

            .card-container {
                width: 45vw;
                max-width: 180px;
                height: 65vw;
                max-height: 260px;
            }

            .card-container:hover .card-inner {
                transform: none;
                /* Disable hover lift on mobile */
            }

            /* Selected State on Mobile - Move UP MORE + Gap */
            .stage.has-selection .card-container.selected {
                transform: translate(0, -25vh) scale(1.1) rotate(0deg) !important;
                z-index: 300;
            }

            /* Drop others down */
            .stage.has-selection .card-container:not(.selected) {
                transform: translate(0, 150vh) !important;
                /* Fly away */
                opacity: 0;
            }

            /* Backdrop */
            #backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.5s;
                z-index: 150;
                -webkit-backdrop-filter: blur(4px);
                backdrop-filter: blur(4px);
            }

            .show-result #backdrop {
                opacity: 1;
                pointer-events: auto;
            }

            /* Restore Result Panel Mobile Style */
            .result-panel {
                width: 90%;
                bottom: 20px;
                top: auto;
                transform: translateX(-50%) translateY(20px);
                padding: 1.2rem;
                background: rgba(255, 255, 255, 0.65);
                -webkit-backdrop-filter: blur(15px);
                backdrop-filter: blur(15px);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.5);
                border-radius: 25px;
                transition-delay: 0s !important;
                /* Ensure no delay on hide */
            }

            .show-result .result-panel {
                transform: translateX(-50%) translateY(0) scale(1);
                transition-delay: 0.6s !important;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.6rem;
            }

            .result-title {
                font-size: 1.5rem;
            }

            .card-container {
                width: 42vw;
                height: 60vw;
            }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
            display: inline-block;
            opacity: 0.7;
        }

        .skeleton-title {
            height: 2.5rem;
            width: 70%;
            margin: 0 auto 0.5rem;
        }

        .skeleton-text {
            height: 1.2rem;
            width: 90%;
            margin: 0.3rem auto;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Name Input Styles */
        .name-input-container {
            margin-top: 1.5rem;
            position: relative;
            display: inline-block;
            transition: opacity 0.3s;
        }

        .name-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            font-family: 'Quicksand', sans-serif;
            font-size: 1rem;
            text-align: center;
            padding: 0.5rem 1rem;
            width: 80%;
            max-width: 260px;
            outline: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .name-input:focus {
            border-bottom-color: #fff;
            width: 90%;
            max-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .name-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }

        /* Responsive fix for mobile input width and placeholder */
        @media (max-width: 480px) {
            .name-input-container {
                width: 90%;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            .name-input {
                width: 100%;
                max-width: 100%;
                font-size: 0.95rem;
            }
        }

        /* Hidden layout specific */
        .show-result .name-input-container {
            opacity: 0;
            pointer-events: none;
        }

        /* Name Input Validation */
        .name-input.shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
    </style>
</head>

<body>
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>


    <header>
        <h1>Foodie Destiny</h1>
        <p class="subtitle">Th·∫ßn Foodie ban m√≥n, nh·∫≠u ƒëi!</p>
        <div class="name-input-container">
            <input type="text" id="nameInput" class="name-input" placeholder="Cho a bi·∫øt t√™n em nh√≥ " autocomplete="off">
        </div>
    </header>

    <div class="stage" id="stage">
        <!-- Cards injected by JS -->
    </div>

    <div class="controls" id="mobileControls">
        <button class="btn-main" onclick="shuffleDeck()" id="btnShuffle">X√†o N·∫•u</button>
    </div>

    <!-- Backdrop for selection -->
    <div id="backdrop" onclick="resetGame()"></div>

    <div class="result-panel" id="resultPanel">
        <h2 class="result-title" id="resultTitle">Title</h2>
        <p class="result-desc" id="resultDesc">Description</p>
        <button class="btn-main" onclick="resetGame()">L·∫°i h√¥ng b√© üòÜ</button>
    </div>

    <script>
        // Sound Manager
        const SoundManager = {
            ctx: null,
            init: function () {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            playTone: function (freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);

                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playShuffle: function () {
                // Rapid noise/ticks
                if (!this.ctx) this.init();
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        this.playTone(100 + Math.random() * 200, 'square', 0.05, 0.05);
                    }, i * 30);
                }
            },
            playFlip: function () {
                if (!this.ctx) this.init();
                this.playTone(400, 'sine', 0.1, 0.1);
            },
            playReveal: function () {
                if (!this.ctx) this.init();
                // Major chord arpeggio
                const now = this.ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    setTimeout(() => {
                        this.playTone(freq, 'triangle', 0.6, 0.1);
                    }, i * 100);
                });
            }
        };

        // Initialize Audio on first interaction
        document.body.addEventListener('click', () => SoundManager.init(), { once: true });
        document.body.addEventListener('touchstart', () => SoundManager.init(), { once: true });

        // Shake Detection
        let lastX, lastY, lastZ;
        let lastTime = 0;
        const SHAKE_THRESHOLD = 15;

        function initShake() {
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (e) => {
                    const current = e.accelerationIncludingGravity;
                    if (!current) return;

                    const currentTime = new Date().getTime();
                    // debounce
                    if ((currentTime - lastTime) > 100) {
                        const diffTime = currentTime - lastTime;
                        lastTime = currentTime;

                        const speed = Math.abs(current.x + current.y + current.z - lastX - lastY - lastZ) / diffTime * 10000;

                        if (speed > SHAKE_THRESHOLD * 100) { // Simple speed check
                            // Check if not already shuffling and no result shown
                            if (!isShuffling && !document.body.classList.contains('show-result')) {
                                if (document.getElementById('nameInput').value.trim()) {
                                    shuffleDeck();
                                }
                            }
                        }

                        lastX = current.x;
                        lastY = current.y;
                        lastZ = current.z;
                    }
                });
            }
        }

        const cardsData = [
            {
                id: 'matcha',
                name: 'Matcha Latte',
                image: 'assets/card-matcha.png',
                desc: 'ƒê·∫Øng nh·∫π nh∆∞ng h·∫≠u v·ªã ng·ªçt s√¢u. Gi·ªëng nh∆∞ ai ƒë√≥, nh√¨n th√¨ l·∫°nh l√πng nh∆∞ng t√¢m √Ω l·∫°i c·ª±c k·ª≥ ·∫•m √°p.',
                emojis: ['üçµ', 'üåø', 'üíö', '‚ú®']
            },
            {
                id: 'boba',
                name: 'Tr√† S·ªØa',
                image: 'assets/card-boba.png',
                desc: 'Ng·ªçt ng√†o, b√©o ng·∫≠y v√† g√¢y nghi·ªán. Coi ch·ª´ng nha, d√≠nh v√†o m√≥n n√†y c≈©ng kh√≥ cai y h·ªát nh∆∞ d√≠nh v√†o √°nh m·∫Øt ai ƒë√≥.',
                emojis: ['üßã', 'üç¨', '‚ú®', 'ü•õ']
            },
            {
                id: 'juice',
                name: 'N∆∞·ªõc √âp Tr√°i C√¢y',
                image: 'assets/card-juice.png',
                desc: 'T∆∞∆°i r√≥i v√† tr√†n tr·ªÅ nƒÉng l∆∞·ª£ng. N·∫°p C tƒÉng ƒë·ªÅ kh√°ng, nh∆∞ng ch·∫Øc kh√¥ng kh√°ng c·ª± n·ªïi s·ª± d·ªÖ th∆∞∆°ng c·ªßa ng∆∞·ªùi ta ƒë√¢u.',
                emojis: ['üçä', 'üçé', 'ü•ï', 'ü•§']
            },
            {
                id: 'fruitbowl',
                name: 'Tr√°i C√¢y T√¥',
                image: 'assets/card-fruitbowl.png',
                desc: 'ƒê·ªß v·ªã chua ng·ªçt, ƒë·∫ßy ·∫Øp s·∫Øc m√†u. M·ªôt s·ª± pha tr·ªôn ho√†n h·∫£o, h·ªát nh∆∞ t√≠nh c√°ch th√∫ v·ªã khi·∫øn ng∆∞·ªùi ta mu·ªën kh√°m ph√° m√£i.',
                emojis: ['üçì', 'ü•ù', 'ü•ë', 'üçâ']
            },
            {
                id: 'peachtea',
                name: 'Tr√† ƒê√†o',
                image: 'assets/card-peachtea.png',
                desc: 'Mi·∫øng ƒë√†o gi√≤n tan, v·ªã tr√† thanh m√°t. Nghe ƒë·ªìn u·ªëng ly n√†y xong, v·∫≠n "ƒë√†o hoa" c≈©ng theo ƒë√≥ m√† n·ªü r·ªô r·ª±c r·ª°.',
                emojis: ['üçë', 'üçµ', '‚ú®', 'üßä']
            },
            {
                id: 'mango',
                name: 'Xo√†i L·∫Øc',
                image: 'assets/card-mango.png',
                desc: 'Chua cay m·∫∑n ng·ªçt ƒë·ªß c·∫£. Gi·ªëng h·ªát c·∫£m gi√°c l√∫c m·ªõi y√™u, v·ª´a h·ªìi h·ªôp l·∫°i v·ª´a mu·ªën th·ª≠ th√™m mi·∫øng n·ªØa.',
                emojis: ['ü•≠', 'üå∂Ô∏è', 'üßÇ', 'üî•']
            },
            {
                id: 'ricepaper',
                name: 'B√°nh Tr√°ng Tr·ªôn',
                image: 'assets/card-ricepaper.png',
                desc: 'Nh√¨n th√¨ r·ªëi b·ªùi nh∆∞ng ƒÉn v√†o l·∫°i cu·ªën kh√¥ng t∆∞·ªüng. C≈©ng nh∆∞ t√¢m tr√≠ ai ƒë√≥ b√¢y gi·ªù, c·ª© r·ªëi tung l√™n ch·ªâ v√¨ m·ªôt ng∆∞·ªùi.',
                emojis: ['üåØ', 'ü•ö', 'üêÇ', 'ü•ú']
            },

        ];

        const stage = document.getElementById('stage');
        const resultPanel = document.getElementById('resultPanel');
        const resultTitle = document.getElementById('resultTitle');
        const resultDesc = document.getElementById('resultDesc');
        const btnShuffle = document.getElementById('btnShuffle');
        const mobileControls = document.getElementById('mobileControls');

        let isMobile = window.innerWidth <= 768;
        let isShuffling = false;

        function validateName() {
            const nameInput = document.getElementById('nameInput');
            if (!nameInput.value.trim()) {
                nameInput.focus();
                nameInput.classList.add('shake');
                setTimeout(() => nameInput.classList.remove('shake'), 500);
                return false;
            }
            return true;
        }

        function initGame() {
            stage.classList.remove('has-selection');

            // Only show shuffle button on mobile
            if (isMobile) {
                mobileControls.style.display = 'flex';
                btnShuffle.style.display = 'block';
                btnShuffle.innerText = "X√†o n·∫•u";
            } else {
                mobileControls.style.display = 'none';
            }

            // Shuffle data first
            const shuffled = [...cardsData].sort(() => 0.5 - Math.random());

            const total = shuffled.length;
            const center = (total - 1) / 2;

            // Check if we need to create cards or just update them
            const existingCards = Array.from(stage.querySelectorAll('.card-container'));
            const needsCreation = existingCards.length !== total;

            if (needsCreation) stage.innerHTML = '';

            shuffled.forEach((cardData, index) => {
                let card;

                if (needsCreation) {
                    card = document.createElement('div');
                    card.className = 'card-container';
                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-back"></div>
                            <div class="card-front"></div>
                        </div>
                    `;
                    // Click logic
                    card.addEventListener('click', () => {
                        // Desktop
                        if (!isMobile) revealCard(card, card.dataset.json ? JSON.parse(card.dataset.json) : cardData);
                        // Mobile
                        else {
                            if (stage.classList.contains('has-selection')) return;
                            revealCard(card, card.dataset.json ? JSON.parse(card.dataset.json) : cardData);
                        }
                    });

                    stage.appendChild(card);
                } else {
                    card = existingCards[index];
                    // Reset state
                    card.classList.remove('selected');
                    card.querySelector('.card-inner').style.transform = 'rotateY(0deg)';
                }

                // Update Data
                card.dataset.name = cardData.name;
                card.dataset.json = JSON.stringify(cardData);
                card.querySelector('.card-front').style.backgroundImage = `url('${cardData.image}')`;

                // Update Position
                if (!isMobile) {
                    // Desktop: Fan Effect
                    const offset = index - center;
                    const x = offset * 60;
                    const rotate = offset * 5;
                    const y = Math.abs(offset) * 10;
                    card.style.transform = `translateX(${x}px) translateY(${y}px) rotate(${rotate}deg)`;
                } else {
                    // Mobile: Deck Stack
                    const randomRot = (Math.random() - 0.5) * 10;
                    card.style.transform = `translate(0, 0) rotate(${randomRot}deg)`;
                }
            });

            if (!document.querySelector('.sparkle')) createSparkles();

            // Init shake listener if not already
            if (isMobile) initShake();
        }

        function shuffleDeck() {
            if (isShuffling) return;
            if (!validateName()) return;

            // iOS Permission Request Interception
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function' && !window.shakePermissionGranted) {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.shakePermissionGranted = true;
                            initShake();
                        }
                    })
                    .catch(console.error);
            }

            isShuffling = true;
            btnShuffle.innerText = "ƒêang n·∫•u...";

            SoundManager.playShuffle();

            const cards = document.querySelectorAll('.card-container');

            // Scatter animation
            const screenW = window.innerWidth;

            cards.forEach((card, i) => {
                // Random scatter positions
                // Constrain to screen width for mobile safer scatter
                const maxSpread = isMobile ? Math.min(150, screenW / 2 - 60) : 200;

                const rx = (Math.random() - 0.5) * maxSpread * 2;
                const ry = (Math.random() - 0.5) * (isMobile ? 100 : 200);
                const rr = (Math.random() - 0.5) * 360;

                card.style.transition = 'transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55)';
                card.style.transform = `translate(${rx}px, ${ry}px) rotate(${rr}deg)`;
            });

            // Rhythmic vibration: tick tick tick
            if (isMobile && navigator.vibrate) {
                navigator.vibrate([30, 50, 30, 50, 30]);
            }

            // Regroup
            setTimeout(() => {
                cards.forEach((card, i) => {
                    const randomRot = (Math.random() - 0.5) * 10;
                    card.style.transform = `translate(0, 0) rotate(${randomRot}deg)`;
                });

                setTimeout(() => {
                    isShuffling = false;
                    btnShuffle.innerText = "M√≥n n√†o ƒë√¢y!";
                    if (isMobile && navigator.vibrate) navigator.vibrate(50); // Heavy thud
                }, 500);

            }, 600);
        }

        function revealCard(cardElement, data) {
            if (stage.classList.contains('has-selection')) return;
            if (isShuffling) return;
            if (!validateName()) return;

            SoundManager.playFlip();

            stage.classList.add('has-selection');
            document.body.classList.add('show-result');
            cardElement.classList.add('selected');

            // Wait for flip
            setTimeout(() => {
                cardElement.querySelector('.card-inner').style.transform = 'rotateY(180deg)';
                SoundManager.playReveal();
                confettiEffect(data);
                if (isMobile && navigator.vibrate) navigator.vibrate([100, 50, 100]); // Success pattern ta-da!
            }, 600);

            setTimeout(() => {
                const nameInput = document.getElementById('nameInput');
                const name = nameInput.value.trim();

                if (name) {
                    resultTitle.innerHTML = `<span style="font-family: 'Quicksand', sans-serif; font-size: 0.5em; display: block; margin-bottom: 0.5rem; color: var(--text-color); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; opacity: 0.7;">L·ªùi nh·∫Øn g·ª≠i ƒë·∫øn ${name}</span> ${data.name}`;
                } else {
                    resultTitle.innerText = data.name;
                }

                resultDesc.innerText = data.desc;
            }, 800);
        }

        function resetGame() {
            // Flip back
            const selected = document.querySelector('.card-container.selected');
            if (selected) {
                selected.querySelector('.card-inner').style.transform = 'rotateY(0deg)';
                selected.classList.remove('selected');
            }

            if (selected) {
                selected.querySelector('.card-inner').style.transform = 'rotateY(0deg)';
                selected.classList.remove('selected');
            }

            stage.classList.remove('has-selection');
            document.body.classList.remove('show-result');

            setTimeout(() => {
                initGame();
                // Show Skeleton Loading to prevent layout shift
                resultTitle.innerHTML = '<div class="skeleton skeleton-title"></div>';
                resultDesc.innerHTML = '<div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text" style="width: 60%"></div>';
            }, 600);
        }

        function createSparkles() {
            const oldSparkles = document.querySelectorAll('.sparkle');
            oldSparkles.forEach(s => s.remove());

            for (let i = 0; i < 30; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + 'vw';
                sparkle.style.top = Math.random() * 100 + 'vh';
                sparkle.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(sparkle);
            }
        }

        function confettiEffect(cardData) {
            // Use specific emojis if available, else standard colors
            const emojis = cardData && cardData.emojis ? cardData.emojis : null;
            const colors = ['#ff80ab', '#d4af37', '#ffffff', '#69f0ae', '#40c4ff'];

            for (let i = 0; i < 50; i++) {
                const conf = document.createElement('div');
                conf.style.position = 'fixed';
                conf.style.zIndex = 400;
                conf.style.top = '50%';
                conf.style.left = '50%';

                if (emojis) {
                    conf.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                    conf.style.fontSize = (Math.random() * 20 + 10) + 'px';
                } else {
                    conf.style.width = Math.random() * 10 + 5 + 'px';
                    conf.style.height = Math.random() * 5 + 5 + 'px';
                    conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                }

                document.body.appendChild(conf);

                // Explode out
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 300 + 50;
                const dx = Math.cos(angle) * dist;
                const dy = Math.sin(angle) * dist;

                // Animate
                const anim = conf.animate([
                    { transform: 'translate(0,0) rotate(0) scale(0.5)', opacity: 1 },
                    { transform: `translate(${dx}px, ${dy}px) rotate(${Math.random() * 720}deg) scale(1)`, opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.25, 1, 0.5, 1)'
                });

                anim.onfinish = () => conf.remove();
            }
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            const newIsMobile = window.innerWidth <= 768;
            if (newIsMobile !== isMobile) {
                isMobile = newIsMobile;
                initGame();
            }
        });

        initGame();

    </script>
</body>

</html>